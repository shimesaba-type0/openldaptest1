- hosts: all
  remote_user: root

  tasks:
    - name: get os version
      command: cat /etc/redhat-release
      # become: yes
      register: result
    - name: debug result ver
      debug:
        msg: "{{ result.stdout }}"

    - name: get karnel information
      command: uname -a
      register: result
    - name: debug result ver
      debug:
        msg: "{{ result.stdout }}"

    - name: Install OpenLDAP servers and clients
      yum:
          name: "{{ packages }}"
          state: latest
      vars:
          packages:
              - openldap-servers
              - openldap-clients
      become: yes
      register: result
    - name: display package install
      debug:
        var: result

    - name: start slapd (OpenLDAP)
      systemd:
          name: slapd
          state: started
      become: yes
      register: result
    - name: display slapd start result
      debug:
        var: result

    - name: enable slapd (OpenLDAP)
      systemd:
          name: slapd
          state: started
          enabled: yes
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    - name: check openldap default configuration SASL=EXTERNAL
      command: ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b cn=config dn
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    - name: check openldap default cn=config dn
      command: ldapsearch -LLL -H ldapi:/// -b cn=config dn
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    - name: check base tree cn=config only
      command: ldapsearch -LLL -H ldapi:/// -b cn=config -s base
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    # 暗黙のデータベース。デフォルトでは何のパラメータも設定されていない。
    - name: display frontend database
      command: ldapsearch -LLL -H ldapi:/// -b olcDatabase={-1}frontend,cn=config
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    # config database
    # OpenLDAP サーバのコンフィグを行うためのデータベース
    # グローバルセクションに該当する
    # 初期値では、OpenLDAP をインストールした root ユーザが
    # ldapi 接続を行った際に manage 権限を与える設定のみがある
    - name: display config database
      command: ldapsearch -LLL -H ldapi:/// -b olcDatabase={0}config,cn=config
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    # monitor database
    # LDAPの動作状況を確認するための database
    # デフォルトではインストールした root ユーザだけが manage 権限を持つ
    - name: display monitor database
      command: ldapsearch -LLL -H ldapi:/// -b olcDatabase={1}monitor,cn=config
      become: yes
      register: result
    - name: display result
      debug:
          var: result

    # 実際にLDAPサーバとして利用するツリーの定義
    - name: display actual default database
      command: ldapsearch -LLL -H ldapi:/// -b olcDatabase={2}hdb,cn=config
      become: yes
      register: result
    - name: display result
      debug:
          var: result


    ### データベースの作成
    # まず止める
    - name: stop slapd (OpenLDAP) before database setting
      systemd:
          name: slapd
          state: stopped
      become: yes
      register: result
    - name: display slapd satus
      debug:
        var: result

    # ファイルを消す
    # [vagrant@localhost ~]$ sudo ls /etc/openldap/slapd.d/cn=config
    # cn=schema  cn=schema.ldif  olcDatabase={-1}frontend.ldif  olcDatabase={0}config.ldif  olcDatabase={1}monitor.ldif  olcDatabase={2}hdb.ldif
    - name: remove configuration file
      file:
          path: /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif
          state: absent
      become: yes
      register: result
    - name: remove configration file result
      debug:
          var: result

